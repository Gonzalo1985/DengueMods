---
title: "Modelos_Dengue - Training (nivel Nacional)"
author: "Gonzalo M. Díaz"
date: "2025-11-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Carga de librerías y autenticación

Carga de librerías y autenticación con Google Drive para leer los datos de las planillas de casos de Dengue:

library('AzureAuth')

```{r}
library('googledrive')
library('stringr')
library('readxl')
library('sf')
library('ggplot2')
library('dplyr')
library('terra')

# Conexión con la cuenta de Google Drive
drive_auth()
```

## Lectura casos de Dengue desde el Google Drive

Se levantan los datos de las las olas "históricas" utilizando la función load.epidemio.data:

```{r}
source("./tidymodels/fcts/load-epidemio-data.R")
```

Se descargan las olas previas, se abren en variable R y luego se eliminan de la carpeta local:

```{r}
ola.22.23 <- load.epidemio.data(wave = "19-20 a 22-23", week = "")
ola.23.24 <- load.epidemio.data(wave = "23-24", week = 30)
ola.24.25 <- load.epidemio.data(wave = "24-25", week = 30)

file.remove(list.files(
  path = "/home/gdiaz/Documentos/Desarrollos/DengueMods/tidymodels",
  pattern = "\\.xlsx$",
  full.names = TRUE))
```

## Estaciones meteorológicas por shp de regiones

Se abren los shp que definen las regiones en donde se entrenarán modelos:

```{r}
shp.list <- list()
shp.list <- lapply(X = list.files("/ms-36/hidro/shp/ALM_Regiones/",
                                  pattern = ".shp", full.names = TRUE),
                   FUN = st_read)
```

Se crea un data.frame con los departamentos que involucra cada región:

```{r}
regiones.list <- c()
regiones.name <- list.files("/ms-36/hidro/shp/ALM_Regiones/", pattern = ".shp")
for (i in 1:length(shp.list))
{
  aux <- data.frame(Region = shp.list[[i]]$nam)
  regiones.list <- append(regiones.list, aux)
}
names(regiones.list) <- regiones.name
```

Se abre el archivo de metadatos de las estaciones meteorológicas

```{r}
metadata.estaciones <- read.csv("../ESTACIONES_SMN.csv", skip = 1, header = FALSE)

# se elimina VICTORICA para el Entrenamiento
metadata.estaciones <- metadata.estaciones[-59,]

colnames(metadata.estaciones) <- c("Provincia", "Estacion", "id", "lat", "lon", "alt")
```

Además, creamos una columna al metadato de estaciones con la distancia de Decorrelación de cada estación:

```{r}
dcorr.map <- rast("./DeCorr/Dist_corr_DEF_imerg_all_ar_1_0.2_g3_s0_qpe.tif")

dcorr.series <- extract(dcorr.map, vect(cbind(metadata.estaciones$lon,
                                              metadata.estaciones$lat)
                                        ),
                        ID = FALSE
                        )

metadata.estaciones <- cbind(metadata.estaciones, dcorr.series)

colnames(metadata.estaciones) <- c("Provincia", "Estacion", "id", "lat", "lon", "alt",
                                   "dcorr")

metadata.estaciones[is.na(metadata.estaciones)] <- 0
```

Se busca los id de las estaciones que cae en cada región y se plotean las regiones juntos con los puntos de estaciones meteorológicas. Además, en celeste se marcan los partidos que han registrado casos de Dengue en la última ola:

```{r}
puntos.sf <- st_as_sf(metadata.estaciones, coords = c("lon", "lat"), crs = 4326)

# Convertir puntos a CRS métrico
puntos.sf.m <- st_transform(puntos.sf, 3857)

# Crear buffer en metros usando la columna dcorr (km)
puntos.buffer <- st_buffer(puntos.sf.m, dist = puntos.sf.m$dcorr * 1000)

# Volver a CRS 4326
puntos.buffer <- st_transform(puntos.buffer, 4326)

for(i in 1:length(shp.list)){
  
  pos <- which(shp.list[[i]]$nam %in% unique(ola.24.25$nombre_dep))
  
  shp.aux <- shp.list[[i]] %>%
    mutate(resaltar = ifelse(
      nam %in% regiones.list[[i]][pos], "Dengue SI", "Dengue NO")
      )
  
  idx <- st_within(puntos.sf, shp.list[[i]])
  puntos.inside <- puntos.sf[lengths(idx) > 0, ]
  buffers.inside <- puntos.buffer[lengths(idx) > 0, ]
    
  f <- ggplot() + geom_sf(data = shp.list[[i]], fill = "lightgray", color = "black") +
                  geom_sf(data = shp.aux, aes(fill = resaltar), color = "black") +
                  geom_sf(data = buffers.inside, fill = NA, color = "black",
                          linetype = "solid", size = 5) +              
                  geom_sf(data = puntos.inside, color = "black", size = 1) +
                  geom_sf(data = puntos.inside, color = "green", size = 0.5) +
                  theme_minimal() +
                  labs(title = names(regiones.list)[i])
  
  # png(paste0(names(regiones.list)[i], ".png"),
  #     width = 6, height = 4, units = "in", res = 300)
  print(f)
  # dev.off()
  
}

```

## Departamentos dentro de cada círculo de influencia por estación

Armado de lista de departamentos que se encuentran en el radio de influencia de cada estación. Los números de región son:

-   Región 1 = Centro

-   Región 2 = Cuyo

-   Región 3 = NEA

-   Región 4 = NOA

-   Región 5 = Pampeana

-   Región 6 = Patagonia

```{r, warning=FALSE}

Region = 6

idx <- st_within(puntos.sf, shp.list[[Region]])
puntos.inside <- puntos.sf[lengths(idx) > 0, ]
buffers.inside <- puntos.buffer[lengths(idx) > 0, ]
  
# intersección de áreas de influencia con departamentos
Deps.in.buffer <- st_intersects(buffers.inside, shp.list[[Region]])

Lista.Estaciones <- c()

# for que recorre estación dentro de región seleccionada
for (j in 1:length(Deps.in.buffer)){
  
  Lista.Estaciones[[j]] <- c(buffers.inside$Estacion[j],
                             shp.list[[Region]]$nam[Deps.in.buffer[[j]]]
                             )
  
}

# Buscar longitud máxima
max.len <- max(sapply(Lista.Estaciones, length))

# Rellenar con NA
lista.pad <- lapply(Lista.Estaciones, function(x) c(x, rep(NA, max.len - length(x))))

# Convertir a matriz
mat <- do.call(rbind, lista.pad)


```
